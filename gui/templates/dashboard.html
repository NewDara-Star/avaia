<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Avaia</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="/static/shared.js"></script>
</head>

<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="new-chat-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14" />
                    </svg>
                    New chat
                </a>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                <a href="/" class="nav-item" data-page="chat">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Chat</span>
                </a>
                <a href="/dashboard" class="nav-item active" data-page="dashboard">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="/learning" class="nav-item" data-page="learning">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                    <span>My Learning</span>
                </a>
                <a href="/projects" class="nav-item" data-page="projects">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Projects</span>
                </a>
                <a href="/reviews" class="nav-item" data-page="reviews">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    <span>Reviews</span>
                    <span class="nav-badge" id="reviewsBadge" style="display: none;">0</span>
                </a>
            </nav>

            <div class="sidebar-divider"></div>

            <!-- Learner Settings -->
            <div class="sidebar-settings" style="margin-top: auto;">
                <div class="settings-section">
                    <label class="settings-label" for="learnerIdInput">Learner ID</label>
                    <div class="settings-input-wrapper">
                        <input
                            type="text"
                            id="learnerIdInput"
                            class="settings-input"
                            placeholder="learner_xxxxx"
                            spellcheck="false"
                            readonly
                        >
                    </div>
                    <p class="settings-hint" id="learnerName"></p>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="status-indicator" id="status">
                    <span class="status-dot" id="statusDot"></span>
                    <span class="status-text" id="statusText">Loading...</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menuToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18" />
                    </svg>
                </button>
                <div class="model-selector">
                    <span class="model-name">Dashboard</span>
                    <span class="model-badge">Stats</span>
                </div>
            </header>

            <div class="page-content" id="pageContent">
                <div class="dashboard-grid">
                    <!-- Stats Row -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value" id="totalTime">--</span>
                                <span class="stat-label">Total Time</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value" id="conceptsLearned">--</span>
                                <span class="stat-label">Concepts Learned</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value" id="projectsBuilt">--</span>
                                <span class="stat-label">Sessions</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon streak">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value" id="streakDays">--</span>
                                <span class="stat-label">Day Streak</span>
                            </div>
                        </div>
                    </div>

                    <!-- Current Project -->
                    <div class="dashboard-card">
                        <h3>Current Project</h3>
                        <div id="currentProject" class="project-card-content">
                            <p class="empty-state">No active project. Start learning to begin!</p>
                        </div>
                    </div>

                    <!-- Due Reviews -->
                    <div class="dashboard-card">
                        <h3>Due for Review</h3>
                        <div id="dueReviews" class="review-list">
                            <p class="empty-state">No reviews due. Great job staying on track!</p>
                        </div>
                        <a href="/reviews" class="card-link">View all reviews</a>
                    </div>

                    <!-- Stubborn Bugs -->
                    <div class="dashboard-card warning" id="stubbornBugsCard" style="display: none;">
                        <h3>Stubborn Bugs</h3>
                        <div id="stubbornBugs" class="bug-list">
                            <p class="empty-state">No stubborn bugs. Keep it up!</p>
                        </div>
                    </div>

                    <!-- Learning Health -->
                    <div class="dashboard-card">
                        <h3>Learning Health</h3>
                        <div class="health-metrics">
                            <div class="health-metric">
                                <span class="metric-label">Independence Score</span>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="independenceBar" style="width: 0%"></div>
                                </div>
                                <span class="metric-value" id="independenceScore">--</span>
                            </div>
                            <div class="health-metric">
                                <span class="metric-label">Verification Pass Rate</span>
                                <div class="metric-bar">
                                    <div class="metric-fill" id="verificationBar" style="width: 0%"></div>
                                </div>
                                <span class="metric-value" id="verificationRate">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Curriculum Updates -->
                    <div class="dashboard-card" id="curriculumCard">
                        <h3>Curriculum</h3>
                        <div id="curriculumStatus" class="curriculum-status">
                            <p class="empty-state">Checking for updates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Status management
        function setStatus(connected, text) {
            const dot = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
            textEl.textContent = text;
        }

        async function loadDashboardData(learnerId) {
            setStatus(false, 'Loading...');
            document.getElementById('statusDot').classList.add('connecting');

            try {
                const data = await apiGet(`/api/dashboard?learner_id=${encodeURIComponent(learnerId)}`);
                renderDashboard(data);
                setStatus(true, 'Connected');
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                setStatus(false, 'Error');
                showError('pageContent', `Failed to load dashboard: ${error.message}`, () => loadDashboardData(learnerId));
            }
        }

        function renderDashboard(data) {
            // Stats
            if (data.time_metrics) {
                document.getElementById('totalTime').textContent = formatTime(data.time_metrics.total_time_minutes);
                document.getElementById('streakDays').textContent = data.time_metrics.streak_days || 0;
                document.getElementById('projectsBuilt').textContent = data.time_metrics.total_sessions || 0;
            }

            if (data.concept_metrics) {
                document.getElementById('conceptsLearned').textContent =
                    (data.concept_metrics.concepts_mastered || 0) + (data.concept_metrics.concepts_learning || 0);
            }

            // Current project
            if (data.current_project) {
                document.getElementById('currentProject').innerHTML = `
                    <div class="project-info">
                        <h4>${data.current_project.name}</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${data.current_project.progress || 0}%"></div>
                        </div>
                        <span class="progress-text">Milestone ${data.current_project.current_milestone || 1} - ${data.current_project.progress || 0}% complete</span>
                    </div>
                `;
            } else {
                document.getElementById('currentProject').innerHTML = `
                    <p class="empty-state">No active project. <a href="/">Start learning</a> to begin!</p>
                `;
            }

            // Due reviews
            if (data.due_reviews && data.due_reviews.length > 0) {
                document.getElementById('dueReviews').innerHTML = data.due_reviews.map(r => `
                    <div class="review-item">
                        <span class="review-concept">${r.concept_name || r.concept_id}</span>
                        <span class="review-context">${r.context || ''}</span>
                    </div>
                `).join('');

                // Update badge
                const badge = document.getElementById('reviewsBadge');
                if (badge) {
                    badge.textContent = data.due_reviews.length;
                    badge.style.display = 'inline-block';
                }
            } else {
                document.getElementById('dueReviews').innerHTML = `
                    <p class="empty-state">No reviews due. Great job staying on track!</p>
                `;
            }

            // Stubborn bugs
            if (data.stubborn_bugs && data.stubborn_bugs.length > 0) {
                document.getElementById('stubbornBugsCard').style.display = 'block';
                document.getElementById('stubbornBugs').innerHTML = data.stubborn_bugs.map(b => `
                    <div class="bug-item">
                        <span class="bug-concept">${b.concept_id}</span>
                        <span class="bug-misconception">${b.misconception_id}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('stubbornBugsCard').style.display = 'none';
            }

            // Health metrics
            if (data.learning_health) {
                const independence = data.learning_health.independence_score || 0;
                const verification = data.learning_health.verification_pass_rate || 0;

                document.getElementById('independenceScore').textContent = `${independence}%`;
                document.getElementById('independenceBar').style.width = `${independence}%`;
                document.getElementById('verificationRate').textContent = `${verification}%`;
                document.getElementById('verificationBar').style.width = `${verification}%`;
            }
        }

        // Curriculum update functions
        async function checkCurriculumUpdates() {
            try {
                const data = await apiGet('/api/curriculum/status');
                renderCurriculumStatus(data);
            } catch (error) {
                console.error('Failed to check curriculum:', error);
                document.getElementById('curriculumStatus').innerHTML = `
                    <p class="empty-state">Unable to check curriculum status</p>
                `;
            }
        }

        function renderCurriculumStatus(data) {
            const container = document.getElementById('curriculumStatus');

            if (data.error) {
                container.innerHTML = `<p class="empty-state">${data.error}</p>`;
                return;
            }

            const installed = data.installed || {};
            const hasUpdates = data.updates_available;
            const pendingCount = data.pending_count || 0;
            const appVersion = data.app_version || {};

            let html = `
                <div class="curriculum-info">
                    <div class="curriculum-stats">
                        <span><strong>${installed.tracks || 0}</strong> tracks</span>
                        <span><strong>${installed.concepts || 0}</strong> concepts</span>
                        <span><strong>${installed.projects || 0}</strong> projects</span>
                    </div>
                    <div class="app-version">
                        <span class="version-label">v${appVersion.installed || 'unknown'}</span>
                    </div>
            `;

            if (hasUpdates) {
                // Build update message
                let updateMsg = [];
                if (appVersion.update_available) {
                    updateMsg.push(`App ${appVersion.installed} â†’ ${appVersion.latest}`);
                }
                if (pendingCount > 0) {
                    updateMsg.push(`${pendingCount} curriculum update${pendingCount > 1 ? 's' : ''}`);
                }

                html += `
                    <div class="curriculum-update-notice">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4M12 16h.01"/>
                        </svg>
                        <span>${updateMsg.join(' + ')}</span>
                    </div>
                    <button class="btn btn-primary" id="applyUpdatesBtn" onclick="applyCurriculumUpdates()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                        </svg>
                        Install Updates
                    </button>
                `;
            } else {
                html += `
                    <p class="curriculum-uptodate">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Up to date
                    </p>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        async function applyCurriculumUpdates() {
            const btn = document.getElementById('applyUpdatesBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 11-6.219-8.56"/>
                    </svg>
                    Installing...
                `;
            }

            try {
                const result = await apiPost('/api/curriculum/update');

                if (result.success) {
                    // Reload curriculum status
                    await checkCurriculumUpdates();

                    // Build success message
                    let successParts = [];
                    if (result.npm_updated) {
                        successParts.push(`App updated to v${result.npm_version}`);
                    }
                    if (result.migrations_applied > 0) {
                        successParts.push(`${result.migrations_applied} curriculum update${result.migrations_applied > 1 ? 's' : ''}`);
                    }

                    // Show success message
                    const container = document.getElementById('curriculumStatus');
                    const notice = document.createElement('div');
                    notice.className = 'curriculum-success';
                    notice.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        ${successParts.join(' + ')} installed!
                    `;
                    container.prepend(notice);

                    // Remove after 5 seconds
                    setTimeout(() => notice.remove(), 5000);

                    // If npm was updated, suggest restart
                    if (result.npm_updated) {
                        setTimeout(() => {
                            if (confirm('App was updated. Restart to apply changes?')) {
                                window.location.reload();
                            }
                        }, 1000);
                    }
                } else {
                    const errorMsg = result.errors?.map(e => e.error).join(', ') || 'Unknown error';
                    alert('Failed to apply updates: ' + errorMsg);
                    await checkCurriculumUpdates();
                }
            } catch (error) {
                console.error('Failed to apply updates:', error);
                alert('Failed to apply updates: ' + error.message);
                await checkCurriculumUpdates();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeLearner((learnerId) => {
                document.getElementById('learnerIdInput').value = learnerId;
                const name = getLearnerName();
                if (name) {
                    document.getElementById('learnerName').textContent = name;
                }
                loadDashboardData(learnerId);
                checkCurriculumUpdates();
            }, 'pageContent');
        });
    </script>
</body>

</html>
