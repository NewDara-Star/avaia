<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaia</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="restartBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    New chat
                </button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <span class="sidebar-label">Today</span>
                    <div class="chat-history-item active">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span>Current Session</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="status-indicator" id="status">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" id="menuToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18"/>
                    </svg>
                </button>
                <div class="model-selector">
                    <span class="model-name">Avaia</span>
                    <span class="model-badge">Tutor</span>
                </div>
            </header>

            <div class="chat-area" id="chatContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-logo">
                        <div class="logo-circle">
                            <span>A</span>
                        </div>
                    </div>
                    <h1>How can I help you learn today?</h1>
                    <div class="suggestion-grid">
                        <button class="suggestion-card" data-message="I want to start learning programming">
                            <div class="suggestion-icon">ðŸš€</div>
                            <div class="suggestion-text">
                                <strong>Start learning</strong>
                                <span>Begin your programming journey</span>
                            </div>
                        </button>
                        <button class="suggestion-card" data-message="Continue where I left off">
                            <div class="suggestion-icon">ðŸ“š</div>
                            <div class="suggestion-text">
                                <strong>Continue learning</strong>
                                <span>Pick up where you left off</span>
                            </div>
                        </button>
                        <button class="suggestion-card" data-message="I need help with something I'm stuck on">
                            <div class="suggestion-icon">ðŸ’¡</div>
                            <div class="suggestion-text">
                                <strong>Get help</strong>
                                <span>Ask about something specific</span>
                            </div>
                        </button>
                        <button class="suggestion-card" data-message="Review what I've learned">
                            <div class="suggestion-icon">ðŸ”„</div>
                            <div class="suggestion-text">
                                <strong>Review concepts</strong>
                                <span>Practice and reinforce learning</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Messages will be inserted here -->
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea
                            id="messageInput"
                            placeholder="Message Avaia..."
                            rows="1"
                            autofocus
                        ></textarea>
                        <button class="send-btn" id="sendBtn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="input-hint">Avaia can make mistakes. Verify important information.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const socket = io();
        const chatContainer = document.getElementById('chatContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const restartBtn = document.getElementById('restartBtn');
        const statusEl = document.getElementById('status');
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');

        let currentResponse = null;
        let outputBuffer = '';
        let renderTimeout = null;
        let isWaiting = false;

        // Configure marked
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (e) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setStatus(connected, text) {
            const dot = statusEl.querySelector('.status-dot');
            const textEl = statusEl.querySelector('.status-text');
            dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
            textEl.textContent = text || (connected ? 'Connected' : 'Disconnected');
        }

        function hideWelcomeScreen() {
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
        }

        function showWelcomeScreen() {
            if (welcomeScreen) {
                welcomeScreen.style.display = 'flex';
            }
        }

        function createMessageElement(type, content = '') {
            hideWelcomeScreen();

            const messageRow = document.createElement('div');
            messageRow.className = `message-row ${type}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';

            if (type === 'user') {
                avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
            } else {
                avatar.innerHTML = '<span>A</span>';
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            if (content) {
                messageContent.innerHTML = type === 'user' ? escapeHtml(content) : renderMarkdown(content);
            }

            messageRow.appendChild(avatar);
            messageRow.appendChild(messageContent);
            chatContainer.appendChild(messageRow);

            return messageContent;
        }

        function addUserMessage(text) {
            createMessageElement('user', text);
            scrollToBottom();
        }

        function addThinkingIndicator() {
            const messageRow = document.createElement('div');
            messageRow.className = 'message-row assistant';
            messageRow.id = 'thinking-indicator';

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = '<span>A</span>';

            const thinking = document.createElement('div');
            thinking.className = 'thinking-indicator';
            thinking.innerHTML = '<span></span><span></span><span></span>';

            messageRow.appendChild(avatar);
            messageRow.appendChild(thinking);
            chatContainer.appendChild(messageRow);
            scrollToBottom();
        }

        function removeThinkingIndicator() {
            const indicator = document.getElementById('thinking-indicator');
            if (indicator) indicator.remove();
        }

        function processOutput(text) {
            // Clean ANSI codes
            text = text.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '');
            text = text.replace(/\x1b\][^\x07]*\x07/g, '');
            // Remove box drawing characters
            text = text.replace(/[â”€â”‚â•­â•®â•°â•¯â”Œâ”â””â”˜â”œâ”¤â”¬â”´â”¼]/g, '');
            return text;
        }

        function renderMarkdown(text) {
            try {
                const cleaned = processOutput(text);
                const html = marked.parse(cleaned);
                return DOMPurify.sanitize(html);
            } catch (e) {
                return escapeHtml(text);
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function scheduleRender() {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                if (currentResponse && outputBuffer) {
                    currentResponse.innerHTML = renderMarkdown(outputBuffer);
                    scrollToBottom();
                }
            }, 50);
        }

        function updateSendButton() {
            const hasText = messageInput.value.trim().length > 0;
            sendBtn.disabled = !hasText || isWaiting;
        }

        // Socket events
        socket.on('connect', () => {
            console.log('Socket connected');
        });

        socket.on('status', (data) => {
            if (data.connected) {
                setStatus(true, data.restarted ? 'Restarted' : 'Connected');
                if (data.restarted) {
                    // Clear messages except welcome screen
                    const messages = chatContainer.querySelectorAll('.message-row');
                    messages.forEach(m => m.remove());
                    showWelcomeScreen();
                    outputBuffer = '';
                    currentResponse = null;
                }
            } else {
                setStatus(false, data.error || 'Disconnected');
            }
        });

        socket.on('output', (data) => {
            removeThinkingIndicator();
            if (!currentResponse) {
                currentResponse = createMessageElement('assistant');
            }
            outputBuffer += data.data;
            scheduleRender();
        });

        socket.on('response_complete', () => {
            isWaiting = false;
            updateSendButton();
            currentResponse = null;
            outputBuffer = '';
        });

        socket.on('process_ended', () => {
            setStatus(false, 'Process ended');
            isWaiting = false;
            updateSendButton();
            removeThinkingIndicator();
            currentResponse = null;
            outputBuffer = '';
        });

        socket.on('error', (data) => {
            console.error('Socket error:', data);
            setStatus(false, 'Error: ' + data.message);
            isWaiting = false;
            updateSendButton();
            removeThinkingIndicator();
        });

        socket.on('disconnect', () => {
            setStatus(false, 'Disconnected');
        });

        // Send message
        function sendMessage(text) {
            const message = text || messageInput.value.trim();
            if (!message || isWaiting) return;

            addUserMessage(message);
            addThinkingIndicator();
            socket.emit('input', { message });

            isWaiting = true;
            currentResponse = null;
            outputBuffer = '';

            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateSendButton();
        }

        // Event listeners
        sendBtn.addEventListener('click', () => sendMessage());

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
            updateSendButton();
        });

        // Restart button
        restartBtn.addEventListener('click', () => {
            if (confirm('Start a new chat? This will clear the current conversation.')) {
                setStatus(false, 'Restarting...');
                socket.emit('restart');
            }
        });

        // Mobile menu toggle
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Suggestion cards
        document.querySelectorAll('.suggestion-card').forEach(card => {
            card.addEventListener('click', () => {
                const message = card.dataset.message;
                if (message) {
                    sendMessage(message);
                }
            });
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });
    </script>
</body>
</html>
