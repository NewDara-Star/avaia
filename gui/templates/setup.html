<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaia Setup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='setup.css') }}">
</head>

<body>
    <div class="setup-container">
        <header class="setup-header">
            <div class="logo">Avaia</div>
            <div class="tagline">AI Programming Teacher</div>
        </header>

        <main class="setup-content">
            <!-- Step 1: Welcome & Status -->
            <section class="step" id="step-welcome" data-step="1">
                <h1>Welcome to Avaia</h1>
                <p class="subtitle">Let's get you set up. This will only take a minute.</p>

                <div class="checklist">
                    <div class="check-item" id="check-auth">
                        <span class="check-icon" data-status="checking">‚óå</span>
                        <span class="check-label">API Key</span>
                        <span class="check-detail"></span>
                    </div>
                    <div class="check-item" id="check-mcp">
                        <span class="check-icon" data-status="checking">‚óå</span>
                        <span class="check-label">Learning Tools</span>
                        <span class="check-detail"></span>
                    </div>
                    <div class="check-item" id="check-db">
                        <span class="check-icon" data-status="checking">‚óå</span>
                        <span class="check-label">Database</span>
                        <span class="check-detail"></span>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" id="btn-start" disabled>Continue</button>
                </div>
            </section>

            <!-- Step 2: Authentication -->
            <section class="step hidden" id="step-auth" data-step="2">
                <h1>Connect to Anthropic</h1>
                <p class="subtitle">Enter your Anthropic API key to power Avaia's AI teaching.</p>

                <div class="auth-options">
                    <div class="auth-option" id="auth-byok">
                        <div class="auth-icon">üîë</div>
                        <h3>Anthropic API Key</h3>
                        <p>Get your API key from <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a></p>
                        <input type="password" id="api-key-input" placeholder="sk-ant-api03-..." class="input-field">
                        <button class="btn btn-primary" id="btn-byok">
                            <span class="btn-text">Save API Key</span>
                            <span class="btn-spinner hidden">‚ü≥</span>
                        </button>
                        <p class="error-message hidden" id="api-key-error"></p>
                    </div>
                </div>

                <div class="info-box">
                    <p>üí° <strong>Tip:</strong> Your API key is stored locally at <code>~/.avaia/api_key</code> and never sent anywhere except to Anthropic's API.</p>
                </div>
            </section>

            <!-- Step 3: Database -->
            <section class="step hidden" id="step-db" data-step="3">
                <h1>Initialize Learning Database</h1>
                <p class="subtitle">Set up your database and load curriculum content.</p>

                <div class="info-box">
                    <p>üìÅ Database location: <code>~/.avaia/avaia.db</code></p>
                    <p>This stores your learning progress and curriculum content (concepts, diagnostics, sandboxes).</p>
                </div>

                <div class="progress-box hidden" id="db-progress">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="progress-text">Initializing and seeding...</p>
                </div>

                <div class="actions" id="db-actions">
                    <button class="btn btn-primary" id="btn-db-init">
                        <span class="btn-text">Initialize Database</span>
                        <span class="btn-spinner hidden">‚ü≥</span>
                    </button>
                </div>
                <p class="error-message hidden" id="db-error"></p>
            </section>

            <!-- Step 4: Complete -->
            <section class="step hidden" id="step-complete" data-step="4">
                <div class="success-icon">‚úì</div>
                <h1>All Set!</h1>
                <p class="subtitle">Avaia is ready to teach you programming.</p>

                <div class="summary-box">
                    <h3>What's next?</h3>
                    <ul>
                        <li>Say "hi" to start your first session</li>
                        <li>Tell Avaia what you want to learn</li>
                        <li>Learn through building real projects</li>
                    </ul>
                </div>

                <div class="actions">
                    <button class="btn btn-primary btn-large" id="btn-start-learning">Start Learning</button>
                </div>
            </section>
        </main>

        <footer class="setup-footer">
            <p>Need help? <a href="https://github.com/NewDara-Star/avaia" target="_blank">Documentation</a></p>
        </footer>
    </div>

    <script>
        // Setup wizard - fetch-based, no socket.io needed
        let currentStep = 1;
        let status = null;

        // Fetch initial status with error handling
        fetch('/setup/status?refresh=true')
            .then(r => {
                if (!r.ok) throw new Error('Status endpoint failed');
                return r.json();
            })
            .then(data => {
                console.log('Status:', data);
                status = data;
                updateChecklist(data);
                determineNextStep(data);
            })
            .catch(err => {
                console.error('Failed to fetch status:', err);
                // Enable button anyway so user can proceed
                document.getElementById('btn-start').disabled = false;
            });

        function updateChecklist(data) {
            updateCheckItem('check-auth', data.auth.authenticated, data.auth.method === 'api_key' ? 'API Key configured' : null);
            updateCheckItem('check-mcp', data.avaia_mcp.installed, 'Built-in tools ready');
            updateCheckItem('check-db', data.database.installed, null);

            // Enable button after status loads
            document.getElementById('btn-start').disabled = false;
        }

        function updateCheckItem(id, success, detail) {
            const item = document.getElementById(id);
            const icon = item.querySelector('.check-icon');
            const detailEl = item.querySelector('.check-detail');

            icon.dataset.status = success ? 'pass' : 'fail';
            icon.textContent = success ? '‚úì' : '‚úó';
            if (detail) detailEl.textContent = detail;
        }

        function determineNextStep(data) {
            // Shows appropriate step when user clicks Continue
            // Order: Auth (2) ‚Üí DB (3) ‚Üí Complete (4)
            if (data.all_ready) {
                showStep(4); // Complete
            }
            // Otherwise, nextStep() handles the logic when Continue is clicked
        }

        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(el => {
                el.classList.add('hidden');
            });
            document.querySelector(`[data-step="${stepNum}"]`).classList.remove('hidden');
            currentStep = stepNum;
        }

        function nextStep() {
            // Determine which step to show based on status
            // Order: Auth (2) ‚Üí DB (3) ‚Üí Complete (4)
            if (!status.auth.authenticated && currentStep < 2) {
                showStep(2);
            } else if (!status.database.installed && currentStep < 3) {
                showStep(3);
            } else {
                showStep(4);
            }
        }

        // Button handlers
        document.getElementById('btn-start').addEventListener('click', () => {
            if (status.all_ready) {
                window.location.href = '/';
            } else {
                nextStep();
            }
        });

        document.getElementById('btn-byok').addEventListener('click', () => {
            const key = document.getElementById('api-key-input').value.trim();
            const btn = document.getElementById('btn-byok');
            const btnText = btn.querySelector('.btn-text');
            const btnSpinner = btn.querySelector('.btn-spinner');
            const errorMsg = document.getElementById('api-key-error');

            // Clear previous errors
            errorMsg.textContent = '';
            errorMsg.classList.add('hidden');

            if (!key || !key.startsWith('sk-ant-')) {
                errorMsg.textContent = 'Please enter a valid Anthropic API key (starts with sk-ant-)';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Show loading state
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');
            btn.disabled = true;

            fetch('/api/set-api-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: key })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        status.auth.authenticated = true;
                        updateCheckItem('check-auth', true, 'API Key');
                        setTimeout(() => nextStep(), 300); // Small delay for visual feedback
                    } else {
                        errorMsg.textContent = 'Failed to save API key: ' + (data.error || 'Unknown error');
                        errorMsg.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    errorMsg.textContent = 'Network error: ' + err.message;
                    errorMsg.classList.remove('hidden');
                })
                .finally(() => {
                    btnText.classList.remove('hidden');
                    btnSpinner.classList.add('hidden');
                    btn.disabled = false;
                });
        });

        // Allow Enter key to submit API key
        document.getElementById('api-key-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('btn-byok').click();
            }
        });

        // Add paste support for API key input
        document.getElementById('api-key-input').addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            e.target.value = text.trim();
        });

        document.getElementById('btn-db-init').addEventListener('click', () => {
            const progress = document.getElementById('db-progress');
            const progressText = progress.querySelector('.progress-text');
            const actions = document.getElementById('db-actions');
            const errorMsg = document.getElementById('db-error');
            const btn = document.getElementById('btn-db-init');

            // Clear errors
            errorMsg.textContent = '';
            errorMsg.classList.add('hidden');

            // Show progress
            progress.classList.remove('hidden');
            actions.classList.add('hidden');
            progressText.textContent = 'Initializing database...';

            // Set timeout (45 seconds for seeding)
            const timeout = setTimeout(() => {
                errorMsg.textContent = 'Initialization is taking longer than expected. Please wait...';
                errorMsg.classList.remove('hidden');
            }, 30000);

            fetch('/setup/install/database', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    clearTimeout(timeout);
                    if (data.success) {
                        progressText.textContent = '‚úì Database initialized successfully!';
                        status.database.installed = true;
                        updateCheckItem('check-db', true, null);
                        setTimeout(() => nextStep(), 800);
                    } else {
                        progress.classList.add('hidden');
                        actions.classList.remove('hidden');
                        errorMsg.textContent = 'Initialization failed: ' + (data.error || 'Unknown error');
                        errorMsg.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    clearTimeout(timeout);
                    progress.classList.add('hidden');
                    actions.classList.remove('hidden');
                    errorMsg.textContent = 'Network error: ' + err.message;
                    errorMsg.classList.remove('hidden');
                });
        });

        document.getElementById('btn-start-learning').addEventListener('click', () => {
            window.location.href = '/';
        });
    </script>
</body>

</html>
